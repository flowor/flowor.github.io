<!doctype html>
<html>
<head>
  <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
</head>
<body>

<h3>Convert Scraped schedule from WhatsUpUmassd into a google calendar csv ready for import</h3>

<p>1. Upload the schedule in json format (provided by the app)</p> <input id="files" type="file" accept=".json"><br>
<p>2. Download</p> <button id="upload">Download cal.csv</button>
<p>3. <a href="https://support.google.com/calendar/answer/37118?visit_id=1-636517926543912162-2119441100&rd=1">Upload to google cal</a></p>


<script type="text/javascript">

    var fileInput = $('#files');
    var uploadButton = $('#upload');

    uploadButton.on('click', function() {
        if (!window.FileReader) {
            alert('Your browser is not supported');
            return false;
        }
        var input = fileInput.get(0);

        // Create a reader object
        var reader = new FileReader();
        if (input.files.length) {
            var textFile = input.files[0];
            // Read the file
            reader.readAsText(textFile);
            // When it's loaded, process it
            $(reader).on('load', processFile);
        } else {
            alert('Please upload a file before continuing')
        }
    });

    function processFile(e) {
        var file = e.target.result,
            results;
        if (file && file.length) {

          // Call converter
          let cal = newJson(file);
          jsonToCsv(cal);

        }
    }

    function formatDate(date) {
      var day = date.getDate();
      day = ('0'  + day).slice(-2);

      var month = date.getMonth() + 1;
      month = ('0'  + month).slice(-2);

      var year = date.getFullYear();

      return (month + '/' + day + '/' + year);
    }

    function formatTime(date) {
      var hours = date.getHours();
      var minutes = date.getMinutes();
      var ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12; // the hour '0' should be '12'
      minutes = minutes < 10 ? '0'+minutes : minutes;
      var strTime = hours + ':' + minutes + ' ' + ampm;
      return strTime;
    }

    function newJson(datatxt) {
      var s = JSON.parse(datatxt);
      var newJ = [];

      s.events.forEach(function(element){
        var eventa = {
          'Subject': element.name,
          'Start Date': formatDate(new Date(element.start_time)),
          'End Date': formatDate(new Date(element.end_time)),
          'Start Time': formatTime(new Date(element.start_time)),
          'End Time': formatTime(new Date(element.end_time)),
          'Description': element.description,
          'Location': element.place.name
        };
        newJ.push(eventa);
      });

      // return new json only containing Subject,Start Date,Start Time, End Date,End Time,Description,Location
      return newJ;
    }

    function jsonToCsv(data) {
      var json = data
      var fields = Object.keys(json[0])
      var replacer = function(key, value) { return value === null ? '' : value }
      var csv = json.map(function(row){
        return fields.map(function(fieldName){
          return JSON.stringify(row[fieldName], replacer)
        }).join(',')
      })
      csv.unshift(fields.join(',')) // add header column

      csv = csv.join('\r\n');
      save('cal.csv', csv)
    }

    function save(filename, data) {
    var blob = new Blob([data], {type: 'text/csv'});
    if(window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveBlob(blob, filename);
    }
    else{
        var elem = window.document.createElement('a');
        elem.href = window.URL.createObjectURL(blob);
        elem.download = filename;
        document.body.appendChild(elem);
        elem.click();
        document.body.removeChild(elem);
    }
}


</script>
</body>
</html>
